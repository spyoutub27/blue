<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>정책 이해도 퀴즈</title>
<style>
:root{
  color-scheme:dark;
  --bg:#040814;
  --surface:rgba(15,22,48,0.78);
  --surface-solid:#101a3c;
  --border:rgba(126,156,255,0.18);
  --accent:#7aa4ff;
  --accent-strong:#3c6cff;
  --text:#eef3ff;
  --muted:#96a4c7;
  --success:#1ed47e;
  --danger:#ff6b6b;
  --radius:20px;
}
*{box-sizing:border-box;}
body{
  margin:0;
  min-height:100vh;
  font-family:'Pretendard','Noto Sans KR','Segoe UI',Roboto,system-ui,sans-serif;
  color:var(--text);
  background:radial-gradient(1200px 800px at 10% -12%,rgba(122,164,255,0.16),transparent),var(--bg);
  position:relative;
}
body::before{
  content:'';
  position:fixed;
  inset:0;
  background:radial-gradient(900px 600px at 80% 0%,rgba(60,108,255,0.2),transparent);
  opacity:0.6;
  pointer-events:none;
}
button{font-family:inherit;}
.top{
  position:sticky;
  top:0;
  z-index:10;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:24px;
  padding:28px clamp(20px,4vw,40px);
  backdrop-filter:saturate(140%) blur(12px);
  background:linear-gradient(90deg,rgba(8,14,30,0.92),rgba(8,14,30,0.72));
  border-bottom:1px solid rgba(255,255,255,0.06);
}
.top__left{display:flex;flex-direction:column;gap:8px;max-width:540px;}
.eyebrow{font-size:12px;letter-spacing:0.2em;text-transform:uppercase;color:var(--muted);}
.top__left h1{margin:0;font-size:clamp(28px,4vw,38px);font-weight:700;}
.subtitle{margin:0;color:var(--muted);font-size:15px;line-height:1.5;}
.mode{margin-top:4px;align-self:flex-start;padding:6px 12px;border-radius:999px;background:rgba(122,164,255,0.12);color:var(--accent);font-size:13px;font-weight:600;letter-spacing:0.02em;}
.mode.review{background:rgba(30,212,126,0.18);color:var(--success);}
.top__right{display:flex;align-items:center;gap:18px;}
.radial{position:relative;width:112px;height:112px;display:flex;align-items:center;justify-content:center;}
.ring{position:absolute;width:100%;height:100%;transform:rotate(-90deg);}
.ring__bg{fill:none;stroke:rgba(122,164,255,0.18);stroke-width:10;}
.ring__fg{fill:none;stroke:var(--accent);stroke-width:10;stroke-linecap:round;transition:stroke-dashoffset .35s ease;}
.radial__label{position:relative;text-align:center;display:flex;flex-direction:column;gap:2px;font-size:13px;color:var(--muted);}
.radial__label strong{font-size:28px;color:var(--text);line-height:1;}
.radial__label em{font-style:normal;font-size:12px;color:var(--muted);}
.score-card{min-width:150px;padding:16px 20px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;gap:6px;box-shadow:0 20px 60px rgba(0,0,0,0.35);}
.score-card span{font-size:13px;color:var(--muted);}
.score-card strong{font-size:28px;}
.layout{
  display:grid;
  grid-template-columns:minmax(0,2fr) minmax(0,1fr);
  gap:24px;
  padding:24px clamp(20px,4vw,40px) 48px;
}
.panel{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:28px;
  box-shadow:0 24px 80px rgba(5,9,18,0.55);
  position:relative;
}
.quiz{display:flex;flex-direction:column;gap:24px;min-height:420px;}
.quiz__meta{display:flex;flex-direction:column;gap:10px;}
.muted{color:var(--muted);}
.progress{height:6px;background:rgba(122,164,255,0.12);border-radius:999px;overflow:hidden;}
.progress__fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-strong));transition:width .4s ease;}
.quiz__question{margin:0;font-size:clamp(20px,3vw,26px);line-height:1.45;}
.quiz__options{display:grid;gap:12px;}
.choice{
  display:flex;
  align-items:center;
  gap:16px;
  padding:16px 18px;
  border-radius:16px;
  background:rgba(9,17,38,0.65);
  border:1px solid rgba(122,164,255,0.18);
  color:inherit;
  font-size:16px;
  line-height:1.5;
  cursor:pointer;
  transition:border-color .25s ease, transform .25s ease, background .25s ease;
}
.choice__index{
  width:32px;
  height:32px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(122,164,255,0.18);
  color:var(--accent);
  font-weight:600;
}
.choice__text{flex:1;text-align:left;}
.choice:hover{border-color:rgba(122,164,255,0.45);transform:translateY(-1px);}
.choice:focus-visible{outline:2px solid var(--accent);outline-offset:3px;}
.choice.selected{border-color:var(--accent);background:rgba(122,164,255,0.18);}
.choice.correct{border-color:rgba(30,212,126,0.7);background:rgba(12,40,32,0.85);}
.choice.wrong{border-color:rgba(255,107,107,0.7);background:rgba(52,20,32,0.75);}
.choice[disabled]{opacity:.85;cursor:default;transform:none;}
.quiz__explain{border-radius:16px;background:rgba(10,24,52,0.75);border:1px solid rgba(122,164,255,0.14);padding:18px;display:flex;flex-direction:column;gap:6px;min-height:96px;opacity:0;visibility:hidden;pointer-events:none;transition:opacity .25s ease;}
.quiz__explain.visible{opacity:1;visibility:visible;pointer-events:auto;}

.quiz__label{text-transform:uppercase;font-size:12px;letter-spacing:0.16em;color:var(--muted);}
.quiz__explain p{margin:0;font-size:15px;line-height:1.6;}
.quiz__foot{display:flex;justify-content:space-between;align-items:center;font-size:14px;color:var(--muted);}
.quiz__foot strong{font-size:18px;color:var(--text);}
.quiz__actions{display:flex;gap:12px;justify-content:flex-end;}
.pill{
  cursor:pointer;
  font-size:15px;
  font-weight:600;
  padding:12px 18px;
  border-radius:999px;
  border:1px solid rgba(122,164,255,0.2);
  background:rgba(9,17,38,0.75);
  color:var(--text);
  transition:background .25s ease, border-color .25s ease, transform .25s ease;
}
.pill:hover{transform:translateY(-1px);border-color:rgba(122,164,255,0.45);}
.pill:focus-visible{outline:2px solid var(--accent);outline-offset:3px;}
.pill.primary{background:linear-gradient(135deg,var(--accent),var(--accent-strong));border-color:transparent;color:#080f21;}
.pill.primary:hover{filter:brightness(1.05);}
.pill.ghost{background:transparent;}
.pill[disabled]{opacity:.45;cursor:not-allowed;transform:none;}
.guide h2{margin:0 0 16px;font-size:20px;}
.guide__list{margin:0 0 24px;padding-left:20px;display:grid;gap:10px;font-size:15px;color:var(--muted);}
.guide__list li{line-height:1.55;}
.note{background:rgba(9,17,38,0.55);border:1px solid rgba(122,164,255,0.12);border-radius:16px;padding:18px;}
.note h3{margin:0 0 8px;font-size:16px;}
.note p{margin:0;font-size:14px;color:var(--muted);line-height:1.6;}
.result{grid-column:1/-1;display:flex;flex-direction:column;gap:24px;}
.result__header h2{margin:0;font-size:24px;}
.result__header p{margin:4px 0 0;color:var(--muted);}
.result__stats{display:flex;gap:20px;flex-wrap:wrap;}
.result__stats div{flex:1 1 180px;background:rgba(9,17,38,0.55);border:1px solid rgba(122,164,255,0.12);border-radius:16px;padding:18px;display:flex;flex-direction:column;gap:6px;}
.result__stats strong{font-size:28px;}
.result__table{overflow:auto;max-height:340px;border-radius:16px;}
.result__table table{width:100%;border-collapse:collapse;font-size:14px;min-width:520px;}
.result__table th,.result__table td{border:1px solid rgba(255,255,255,0.08);padding:10px 12px;text-align:left;}
.result__table tbody tr.correct{background:rgba(12,40,32,0.45);}
.result__table tbody tr.wrong{background:rgba(52,20,32,0.45);}
.result__actions{display:flex;gap:12px;justify-content:flex-end;}
.overlay{
  position:fixed;
  inset:0;
  background:rgba(4,8,20,0.88);
  backdrop-filter:blur(18px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:20;
}
.overlay[hidden]{display:none;}
.intro{width:min(620px,calc(100vw - 64px));max-width:620px;min-width:min(540px,calc(100vw - 64px));text-align:center;background:var(--surface);border:1px solid var(--border);padding:40px 48px;border-radius:28px;display:flex;flex-direction:column;gap:20px;box-shadow:0 24px 80px rgba(5,9,18,0.65);} 
.intro h2{margin:0;font-size:clamp(24px,3.4vw,34px);white-space:nowrap;word-break:keep-all;letter-spacing:-0.01em;}
.intro p{margin:0;color:var(--muted);line-height:1.6;font-size:15px;}
.intro__status{margin:0;color:var(--muted);font-size:14px;}
.intro__status.is-ready{color:var(--accent);}
.intro__status.is-error{color:var(--danger);}
.intro__start{align-self:center;padding-inline:28px;}
@media (max-width:640px){
  .intro{width:calc(100vw - 40px);min-width:0;padding:32px 24px;border-radius:24px;gap:16px;}
  .intro h2{white-space:normal;font-size:24px;}
}
@media (max-width:1024px){
  .layout{grid-template-columns:1fr;grid-auto-rows:auto;}
  .guide{order:3;}
  .result{order:4;}
  .top{position:static;}
}
@media (max-width:720px){
  .top{flex-direction:column;align-items:flex-start;}
  .top__right{width:100%;justify-content:space-between;}
  .layout{padding-bottom:36px;}
  .quiz__actions{flex-direction:column;}
  .score-card{min-width:0;width:100%;}
}
@media (prefers-reduced-motion:reduce){
  *,*::before,*::after{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important;scroll-behavior:auto!important;}
}
</style>
</head>
<body>
<header class="top">
  <div class="top__left">
    <span class="eyebrow">Policy Literacy</span>
    <h1>정책 이해도 퀴즈</h1>
    <p class="subtitle">디지털 행정과 공공데이터 활용에 대한 핵심 포인트를 빠르게 점검해 보세요.</p>
    <div class="mode" id="mode-badge">전체 모드</div>
  </div>
  <div class="top__right">
    <div class="radial">
      <svg class="ring" viewBox="0 0 120 120" aria-hidden="true">
        <circle class="ring__bg" cx="60" cy="60" r="52"></circle>
        <circle class="ring__fg" cx="60" cy="60" r="52" stroke-dasharray="327" stroke-dashoffset="0"></circle>
      </svg>
      <div class="radial__label">
        <span>남은 시간</span>
        <strong id="time">25</strong>
        <em>초</em>
      </div>
    </div>
    <div class="score-card">
      <span>획득 점수</span>
      <strong id="score">0</strong>
    </div>
  </div>
</header>
<main class="layout">
  <section class="panel quiz" id="stage" hidden>
    <div class="quiz__meta">
      <span class="muted" id="progress-text">문제 1 / 10</span>
      <div class="progress">
        <div class="progress__fill" id="progress-fill"></div>
      </div>
    </div>
    <h2 class="quiz__question" id="q">-</h2>
    <div class="quiz__options" id="opts"></div>
    <div class="quiz__explain" id="explain" aria-hidden="true">
      <span class="quiz__label">정답 해설</span>
      <p id="explain-text"></p>
    </div>
    <div class="quiz__foot">
      <span>문제 <strong id="idx">0</strong> / <span id="total">0</span></span>
      <span class="muted">객관식 4지선다 · 25초 제한</span>
    </div>
    <div class="quiz__actions">
      <button type="button" class="pill ghost" id="skip">건너뛰기</button>
      <button type="button" class="pill primary" id="next">정답 확인</button>
    </div>
  </section>
  <aside class="panel guide" id="guide">
    <h2>진행 가이드</h2>
    <ul class="guide__list">
      <li>각 문항마다 핵심 정책 개념을 짚어 드립니다.</li>
      <li>정답을 선택하면 해설과 정책 배경을 바로 확인할 수 있습니다.</li>
      <li>오답은 결과 화면에서 따로 복습할 수 있어요.</li>
    </ul>
    <div class="note">
      <h3>이 퀴즈를 활용하는 방법</h3>
      <p>간단한 사전 교육이나 워크숍 아이스브레이킹, 신규 직원 온보딩 등에 활용하면 정책 이해도를 빠르게 점검할 수 있습니다. 결과 데이터는 팀 학습 계획을 세우는 자료로도 사용할 수 있습니다.</p>
    </div>
  </aside>
  <section class="panel result" id="result" hidden>
    <div class="result__header">
      <h2>결과 요약</h2>
      <p id="summary-text">총 0문제 중 0문제를 맞혔어요.</p>
    </div>
    <div class="result__stats">
      <div>
        <span class="muted">획득 점수</span>
        <strong id="final">0</strong>
      </div>
      <div>
        <span class="muted">정답률</span>
        <strong id="accuracy">0%</strong>
      </div>
    </div>
    <div class="result__table">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>문항</th>
            <th>선택한 답</th>
            <th>정답</th>
            <th>판정</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
    <div class="result__actions">
      <button type="button" class="pill ghost" id="retry">처음부터</button>
      <button type="button" class="pill primary" id="review">오답만 다시 풀기</button>
    </div>
  </section>
</main>
<div class="overlay" id="intro">
  <div class="intro">
    <span class="eyebrow">Start</span>
    <h2>정책 이해도를 간단히 점검해 보세요</h2>
    <p>25초 안에 문항을 풀고 해설을 통해 최신 정책 포인트를 짚어봅니다. 준비되셨다면 아래 버튼을 눌러 시작해주세요.</p>
    <p class="intro__status" id="status-text">문항을 불러오는 중입니다...</p>
    <button type="button" class="pill primary intro__start" id="start" disabled>퀴즈 시작하기</button>
  </div>
</div>
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = "https://glculvahppprsyzfctya.supabase.co"; // TODO: replace with your Supabase project URL
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdsY3VsdmFocHBwcnN5emZjdHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxODAxMTAsImV4cCI6MjA3Mzc1NjExMH0.KEZD6PblJWEy0YXOHD5zujzrpjbW3S98f5VgNWVHVzE"; // TODO: replace with your Supabase anon key
const TABLE_NAME = "policy_quiz_questions";

const hasSupabaseConfig = SUPABASE_URL && !SUPABASE_URL.includes("YOUR-PROJECT") && SUPABASE_ANON_KEY && !SUPABASE_ANON_KEY.includes("YOUR_ANON_KEY");
const supabase = hasSupabaseConfig ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

let QUESTION_POOL = [];
let QUESTIONS = [];
const DURATION = 25;
const QUESTION_LIMIT = 10;
const $stage = document.getElementById('stage');
const $guide = document.getElementById('guide');
const $result = document.getElementById('result');
const $intro = document.getElementById('intro');
const $start = document.getElementById('start');
const $statusText = document.getElementById('status-text');
const $q = document.getElementById('q');
const $opts = document.getElementById('opts');
const $explain = document.getElementById('explain');
const $explainText = document.getElementById('explain-text');
const $score = document.getElementById('score');
const $idx = document.getElementById('idx');
const $total = document.getElementById('total');
const $progressText = document.getElementById('progress-text');
const $progressFill = document.getElementById('progress-fill');
const $time = document.getElementById('time');
const $ring = document.querySelector('.ring__fg');
const $next = document.getElementById('next');
const $skip = document.getElementById('skip');
const $final = document.getElementById('final');
const $accuracy = document.getElementById('accuracy');
const $summary = document.getElementById('summary-text');
const $tbody = document.getElementById('tb');
const $retry = document.getElementById('retry');
const $review = document.getElementById('review');
const $modeBadge = document.getElementById('mode-badge');

const state = {
  idx:0,
  score:0,
  seconds:DURATION,
  picked:null,
  locked:false,
  timer:null,
  answers:[],
  mode:'full'
};

let activeSet = QUESTIONS.slice();
let lastAnswers = [];

function setStatus(message, variant = "info"){
  if(!$statusText) return;
  $statusText.textContent = message;
  $statusText.classList.remove("is-error","is-ready");
  if(variant === "error"){
    $statusText.classList.add("is-error");
  } else if(variant === "ready"){
    $statusText.classList.add("is-ready");
  }
}

function parseOptions(raw){
  if(Array.isArray(raw)) return raw;
  if(typeof raw === "string" && raw.trim().length){
    try {
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch (err) {
      console.warn("옵션 JSON 파싱 실패", err);
    }
  }
  return [];
}

function shuffleArray(list){
  const arr = list.slice();
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function pickQuestionSet(){
  if(!QUESTION_POOL.length) return [];
  const limit = Math.min(QUESTION_LIMIT, QUESTION_POOL.length);
  return shuffleArray(QUESTION_POOL).slice(0, limit);
}

async function fetchQuestions(){
  if(!supabase){
    setStatus('Supabase URL과 키를 설정한 뒤 새로고침 해주세요.', 'error');
    return;
  }
  setStatus('문항을 불러오는 중입니다...');
  try {
    const { data, error } = await supabase
      .from(TABLE_NAME)
      .select('id, question, options, answer_index, explanation, display_order, is_active')
      .eq('is_active', true)
      .order('display_order', { ascending: true })
      .order('id', { ascending: true });

    if(error){
      console.error('Supabase fetch error', error);
      setStatus('문항을 불러오는 데 실패했습니다. 잠시 후 다시 시도해주세요.', 'error');
      return;
    }
    if(!data || !data.length){
      setStatus('등록된 문항이 없습니다. Supabase에 문항을 추가해주세요.', 'error');
      return;
    }

    const cleaned = data.map((row, index)=>{
      const opts = parseOptions(row.options);
      const answerIndex = Number.isFinite(Number(row.answer_index)) ? Number(row.answer_index) : 0;
      const safeIndex = opts.length ? Math.min(Math.max(answerIndex, 0), opts.length - 1) : 0;
      return {
        id: row.id ?? `row-${index}`,
        q: row.question ?? '',
        opts,
        a: safeIndex,
        why: row.explanation ?? ''
      };
    }).filter(item=>item.opts.length >= 2 && item.q.trim().length);

    if(!cleaned.length){
      setStatus('활성화된 문항을 찾을 수 없습니다. 옵션과 문항 내용을 확인해주세요.', 'error');
      return;
    }

    QUESTION_POOL = cleaned;
    QUESTIONS = pickQuestionSet();

    if(!QUESTIONS.length){
      setStatus('사용 가능한 문항이 충분하지 않습니다. Supabase 데이터를 확인해주세요.', 'error');
      return;
    }

    setStatus(`총 ${QUESTION_POOL.length}문항 중 ${QUESTIONS.length}문항을 불러왔습니다. 시작 버튼을 눌러주세요.`, 'ready');
    $start.disabled = false;
  } catch (err) {
    console.error('Supabase fetch error', err);
    setStatus('문항을 불러오는 중 오류가 발생했습니다.', 'error');
  }

}

const CIRCUMFERENCE = 2 * Math.PI * 52;
$ring.style.strokeDasharray = CIRCUMFERENCE.toFixed(1);

function resetQuiz(subset = QUESTIONS, mode = 'full'){
  if(!subset || !subset.length){
    setStatus('사용 가능한 문항이 없습니다. Supabase 데이터를 확인해주세요.', 'error');
    return;
  }
  activeSet = subset.slice();
  state.idx = 0;
  state.score = 0;
  state.seconds = DURATION;
  state.picked = null;
  state.locked = false;
  state.answers = [];
  state.mode = mode;
  $modeBadge.textContent = mode === 'review' ? '오답 복습 모드' : '전체 모드';
  $modeBadge.classList.toggle('review', mode === 'review');
  $score.textContent = '0';
  $total.textContent = activeSet.length;
  $stage.hidden = false;
  $result.hidden = true;
  $intro.hidden = true;
  updateProgress();
  updateTime();
  render();
}

function render(){
  clearTimer();
  if(state.idx >= activeSet.length){
    finish();
    return;
  }
  const current = activeSet[state.idx];
  state.seconds = DURATION;
  state.picked = null;
  state.locked = false;
  $skip.disabled = false;
  $skip.textContent = '건너뛰기';
  $idx.textContent = state.idx + 1;
  $q.textContent = current.q;
  $opts.innerHTML = '';
  current.opts.forEach((text,index)=>{
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'choice';
    btn.dataset.index = index;
    btn.innerHTML = `<span class="choice__index">${index+1}</span><span class="choice__text">${text}</span>`;
    btn.addEventListener('click',()=>selectOption(index));
    btn.addEventListener('keydown',(e)=>{
      if(e.key==='Enter' || e.key===' '){
        selectOption(index);
        e.preventDefault();
      }
    });
    $opts.appendChild(btn);
  });
  $explain.classList.remove('visible');
  $explain.setAttribute('aria-hidden','true');
  $explainText.textContent = '';
  $next.textContent = '정답 확인';
  updateProgress();
  updateTime();
  startTimer();
}

function selectOption(index){
  if(state.locked) return;
  state.picked = index;
  document.querySelectorAll('.choice').forEach(choice=>{
    const same = Number(choice.dataset.index) === index;
    choice.classList.toggle('selected', same);
  });
}

function startTimer(){
  clearTimer();
  state.timer = setInterval(()=>{
    state.seconds -= 1;
    updateTime();
    if(state.seconds <= 0){
      clearTimer();
      lock();
    }
  },1000);
}

function clearTimer(){
  if(state.timer){
    clearInterval(state.timer);
    state.timer = null;
  }
}

function updateTime(){
  const value = Math.max(state.seconds,0);
  $time.textContent = String(value).padStart(2,'0');
  updateRing(value);
}

function updateRing(remain){
  const ratio = Math.max(remain,0) / DURATION;
  const offset = CIRCUMFERENCE * (1 - Math.min(ratio,1));
  $ring.style.strokeDashoffset = offset.toFixed(1);
}

function updateProgress(){
  const total = activeSet.length || 1;
  const ratio = state.idx / total;
  $progressFill.style.width = (ratio * 100).toFixed(1) + '%';
  const displayIndex = Math.min(state.idx + 1, total);
  $progressText.textContent = `문제 ${displayIndex} / ${total}`;
}

function lock(){
  if(state.locked) return;
  state.locked = true;
  clearTimer();
  const current = activeSet[state.idx];
  const correct = state.picked === current.a;
  if(correct){
    state.score += 1;
    $score.textContent = state.score;
  }
  document.querySelectorAll('.choice').forEach(choice=>{
    const optionIndex = Number(choice.dataset.index);
    if(optionIndex === current.a){
      choice.classList.add('correct');
    }
    if(state.picked !== null && optionIndex === state.picked && optionIndex !== current.a){
      choice.classList.add('wrong');
    }
    choice.disabled = true;
  });
  $explain.classList.add('visible');
  $explain.setAttribute('aria-hidden','false');
  $explainText.textContent = current.why;
  $skip.disabled = true;
  const record = {
    id:current.id,
    question:current.q,
    options:current.opts.slice(),
    picked:state.picked,
    answer:current.a,
    correct
  };
  state.answers.push(record);
  if(state.idx === activeSet.length - 1){
    $next.textContent = '결과 보기';
  } else {
    $next.textContent = '다음 문제';
  }
}

function goNext(){
  if(!state.locked){
    lock();
    return;
  }
  if(state.idx < activeSet.length - 1){
    state.idx += 1;
    render();
  } else {
    finish();
  }
}

function finish(){
  clearTimer();
  $stage.hidden = true;
  $result.hidden = false;
  $progressFill.style.width = '100%';
  $progressText.textContent = '퀴즈 완료';
  const total = activeSet.length;
  const accuracy = total ? Math.round((state.score / total) * 100) : 0;
  $final.textContent = state.score;
  $accuracy.textContent = `${accuracy}%`;
  $summary.textContent = `총 ${total}문제 중 ${state.score}문제를 맞혔어요.`;
  $tbody.innerHTML = '';
  state.answers.forEach((row,index)=>{
    const tr = document.createElement('tr');
    tr.className = row.correct ? 'correct' : 'wrong';
    const pickedText = row.picked === null ? '-' : row.options[row.picked];
    const answerText = row.options[row.answer];
    tr.innerHTML = `<td>${index+1}</td><td>${row.question}</td><td>${pickedText}</td><td>${answerText}</td><td>${row.correct ? '정답' : '오답'}</td>`;
    $tbody.appendChild(tr);
  });
  lastAnswers = state.answers.map(item=>({...item}));
}

$next.addEventListener('click', goNext);
$skip.addEventListener('click', ()=>{
  if(state.locked) return;
  state.picked = null;
  lock();
});

function beginFullQuiz(){
  if(!QUESTION_POOL.length){
    setStatus('문항 데이터가 없습니다. Supabase를 확인해주세요.', 'error');
    return false;
  }
  QUESTIONS = pickQuestionSet();
  if(!QUESTIONS.length){
    setStatus('사용 가능한 문항이 충분하지 않습니다. Supabase 데이터를 확인해주세요.', 'error');
    return false;
  }
  resetQuiz(QUESTIONS, 'full');
  return true;
}

$retry.addEventListener('click', ()=>{
  resetQuiz(QUESTIONS, 'full');
});

$review.addEventListener('click', ()=>{
  if(!lastAnswers.length){
    resetQuiz(QUESTIONS, 'full');
    return;
  }
  const wrong = lastAnswers.filter(item=>!item.correct);
  if(!wrong.length){
    alert('오답이 없습니다. 전체 모드로 다시 시작합니다.');
    resetQuiz(QUESTIONS, 'full');
    return;
  }
  const subset = wrong.map(item=>QUESTIONS.find(q=>q.id===item.id)).filter(Boolean);
  resetQuiz(subset, 'review');
});

$start.addEventListener('click', () => {
  if($start.disabled) return;
  beginFullQuiz();
});

fetchQuestions();
document.addEventListener('keydown', (e)=>{
  if($intro.hidden === false){
    if((e.key === 'Enter' || e.key === ' ') && !$start.disabled){
      e.preventDefault();
      beginFullQuiz();
    }
    return;
  }
  if($result.hidden === false){
    if(e.key === 'Enter'){
      e.preventDefault();
      beginFullQuiz();
    }
    return;
  }
  if(e.key === 'Enter'){
    e.preventDefault();
    goNext();
    return;
  }
  const mapping = {'1':0,'2':1,'3':2,'4':3};
  if(mapping[e.key] !== undefined){
    selectOption(mapping[e.key]);
  }
});

window.addEventListener('beforeunload', ()=>{
  clearTimer();
});
</script>
</body>
</html>
















































